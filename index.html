function updateIcon() {
    let val = iconInput.value.trim() || "clever.com";
    
    // If the user didn't type http/https, we format it to help the API
    let fetchUrl = val;
    if (!val.startsWith('http')) {
        fetchUrl = 'https://' + val;
    }

    try {
        // We extract the hostname to ensure the API targets the specific subdomain provided
        const urlObj = new URL(fetchUrl);
        const domain = urlObj.hostname;
        
        // Using 'sz=128' for higher quality and ensuring the domain matches exactly
        const finalIconUrl = `https://www.google.com/s2/favicons?sz=128&domain=${domain}`;
        
        localStorage.setItem('customCloakIcon', finalIconUrl);
        
        if (cloakToggle.checked) {
            document.getElementById('favicon').href = finalIconUrl;
        }
    } catch (e) {
        // Fallback if the URL is malformed
        const fallback = `https://www.google.com/s2/favicons?sz=128&domain=${val}`;
        localStorage.setItem('customCloakIcon', fallback);
        if (cloakToggle.checked) document.getElementById('favicon').href = fallback;
    }
}
